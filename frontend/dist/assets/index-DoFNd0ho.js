import{r as g,j as t,c as xe}from"./vendor_react-CoKp6ti6.js";import{W as we}from"./vendor_web3modal--fUhazQ0.js";import{B as ye,g as Se,C as B,Z as I,f as V,p as q,I as Y,M as be}from"./vendor_ethers-BoEvARgB.js";import{f as te}from"./vendor-39OnbKzn.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function s(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(r){if(r.ep)return;r.ep=!0;const a=s(r);fetch(r.href,a)}})();function Ae({onChange:e=()=>{},onChainChange:n=()=>{}}){const[s,i]=g.useState(!1),[r,a]=g.useState(null);g.useEffect(()=>{},[]);async function l(){try{const o=await new we({cacheProvider:!0}).connect(),f=new ye(o),p=f.getSigner(),u=await p.getAddress(),h=await f.getNetwork();i(!0),a(u),e({provider:f,signer:p,address:u}),n(h.chainId)}catch(d){console.error("connect err",d)}}return t.jsx("div",{children:s?t.jsxs("div",{children:["Connected: ",r]}):t.jsx("button",{onClick:l,children:"Connect Wallet"})})}function Ce({status:e}){return e?t.jsxs("div",{style:{marginTop:12},children:[t.jsx("strong",{children:"Transaction status:"})," ",String(e)]}):null}function je({message:e}){return e?t.jsxs("div",{style:{background:"#fee",padding:8,border:"1px solid #f88"},children:[t.jsx("strong",{children:"Error: "}),e]}):null}const Ee=60*1e3,H=new Map,ve={1:"ethereum",137:"polygon-pos",80001:"polygon-pos",56:"binance-smart-chain",43114:"avalanche"},ke={1:"0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",137:"0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174",43114:"0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E",80001:void 0},De={1:"0x7a250d5630B4cF539739dF2C5dAcb4c659F2488D",137:"0xa5E0829CaCEd8fFDD4De3c43696c57F7D7A678ff",43114:"0x60aE616a2155Ee3d9A68541Ba4544862310933d4"},Te=["function latestRoundData(address base, address quote) view returns (uint80, int256, uint256, uint256, uint80)"],Ie=["function getAmountsOut(uint256 amountIn, address[] calldata path) external view returns (uint256[] memory amounts)"],Pe=["function getReserves() external view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)","function token0() external view returns (address)","function token1() external view returns (address)"],ne=["function decimals() view returns (uint8)"];function ie(e){try{return Se(e)}catch{return e}}async function Be(e,n){if(!n||!n.provider||!n.chainlinkRegistryAddress)return null;try{const s=n.provider,i=new B(n.chainlinkRegistryAddress,Te,s),r=n.chainlinkUsdAddress||I,a=ie(e),d=(await i.latestRoundData(a,r))[1];if(!d||d.eq(0))return null;const o=n.chainlinkDecimals??8;return{price:Number(V(d,o)),source:"chainlink",liquidityScore:100}}catch{return null}}async function _e(e,n,s){const i=ve[n];if(!i)return null;const r=`${i}:${e.toLowerCase()}`,a=s&&s.coingeckoCacheTTL||Ee,l=Date.now();if(H.has(r)){const d=H.get(r);if(l-d.ts<a)return d.data}try{const d=`https://api.coingecko.com/api/v3/simple/token_price/${i}?contract_addresses=${e}&vs_currencies=usd`,o={};s&&s.coingeckoApiKey&&(o["x-api-key"]=s.coingeckoApiKey);const f=await fetch(d,{headers:o});if(!f.ok)return null;const u=(await f.json())[e.toLowerCase()];if(!u||!u.usd)return null;const h={price:Number(u.usd),source:"coingecko",liquidityScore:80};return H.set(r,{ts:l,data:h}),h}catch{return null}}async function Re(e,n,s){if(!s||!s.provider)return null;const i=s.provider,r=s.routerAddress||De[n],a=s.stablecoinAddress||ke[n];if(!r||!a)return null;try{const l=new B(r,Ie,i),d=q("1",18),o=new B(e,ne,i);let f=18;try{f=await o.decimals()}catch{f=18}const p=[e,a],u=await l.getAmountsOut(q("1",f),p);if(!u||u.length===0)return null;const h=u[u.length-1],m=new B(a,ne,i);let A=6;try{A=await m.decimals()}catch{A=6}const w=Number(V(h,A));let x=50;if(s.pairAddress)try{const b=new B(s.pairAddress,Pe,i),C=await b.getReserves(),E=await b.token0(),j=await b.token1();let P=E.toLowerCase()===a.toLowerCase()?C.reserve0:C.reserve1;const v=Number(V(P,A));v>1e6?x=100:v>1e5?x=80:v>1e4?x=60:x=30}catch{}return{price:w,source:"onchain-router",liquidityScore:x}}catch{return null}}async function Ne(e,n,s={}){if(!e)return{price:null,source:"unknown",liquidityScore:0};const i=ie(e),r=await Be(i,s);if(r)return r;const a=await _e(i,n,s);if(a)return a;const l=await Re(i,n,s);return l||{price:null,source:"unknown",liquidityScore:0}}const oe=2n**160n-1n;async function re(e=[],n={}){var j,P;if(!e||e.length===0)return{permitCalldata:"0x",meta:null};const s=e[0],i=n.signer||(n.provider?(P=(j=n.provider).getSigner)==null?void 0:P.call(j):null),r=n.permit2Address;if(!i||!r)return{permitCalldata:"0x",meta:null};const a=await i.getAddress(),d=(n.chainId?{chainId:n.chainId}:await i.provider.getNetwork()).chainId,o=n.amount?BigInt(n.amount.toString?n.amount.toString():String(n.amount)):oe,f=Math.floor(Date.now()/1e3)+(n.expirationSecondsFromNow||60*60*24*30),p=n.nonce!=null?n.nonce:0,u=n.spender||n.sweeperAddress||I,h={name:"Permit2",version:"1",chainId:d,verifyingContract:r},m={PermitSingle:[{name:"token",type:"address"},{name:"amount",type:"uint160"},{name:"expiration",type:"uint48"},{name:"nonce",type:"uint48"},{name:"spender",type:"address"}]},A={token:s,amount:o.toString(),expiration:f,nonce:p,spender:u};let w;try{w=await i._signTypedData(h,m,A)}catch(v){return console.error("Permit2: failed to sign typed data",v),{permitCalldata:"0x",meta:null}}const x=new Y(["function permit(address owner, tuple(address token, uint160 amount, uint48 expiration, uint48 nonce, address spender) permit, bytes signature)"]),b=[s,o.toString(),f,p,u],C=x.encodeFunctionData("permit",[a,b,w]),E={owner:a,token:s,amount:o.toString(),expiration:f,nonce:p,spender:u,signature:w};return{permitCalldata:C,meta:E}}async function Fe(e=[],n={}){var O,N;if(!e||e.length===0)return{permitCalldata:"0x",meta:null};const s=n.signer||(n.provider?(N=(O=n.provider).getSigner)==null?void 0:N.call(O):null),i=n.permit2Address;if(!s||!i)return{permitCalldata:"0x",meta:null};const r=await s.getAddress(),l=(n.chainId?{chainId:n.chainId}:await s.provider.getNetwork()).chainId,d=e.length,o=[],f=[],p=[],u=[],h=Math.floor(Date.now()/1e3)+(n.expirationSecondsFromNow||60*60*24*30),m=n.nonce!=null?n.nonce:0,A=n.spender||n.sweeperAddress||I;for(let T=0;T<d;T++){const W=n.amounts&&n.amounts[T]?BigInt(n.amounts[T].toString?n.amounts[T].toString():String(n.amounts[T])):oe;o.push(W.toString()),f.push(h),p.push(m),u.push(A)}const w={name:"Permit2",version:"1",chainId:l,verifyingContract:i},x={PermitBatch:[{name:"tokens",type:"address[]"},{name:"amounts",type:"uint160[]"},{name:"expirations",type:"uint48[]"},{name:"nonces",type:"uint48[]"},{name:"spenders",type:"address[]"}]},b={tokens:e,amounts:o,expirations:f,nonces:p,spenders:u};let C;try{C=await s._signTypedData(w,x,b)}catch(T){return console.error("Permit2 batch: failed to sign typed data",T),{permitCalldata:"0x",meta:null}}const E=new Y(["function permit(address owner, tuple(address[] tokens, uint160[] amounts, uint48[] expirations, uint48[] nonces, address[] spenders) permit, bytes signature)"]),j=[e,o,f,p,u];return{permitCalldata:E.encodeFunctionData("permit",[r,j,C]),meta:{owner:r,tokens:e,amounts:o,expirations:f,nonces:p,spenders:u,signature:C}}}const se="https://api.1inch.io/v5.0",ce="0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE";function ae(e){if(!e)return e;try{if(e===I)return ce}catch{}return e}function Le(e){if(!e)return!1;const n=e.toLowerCase();return n===I||n===ce.toLowerCase()}async function le(e,n,s,i=1,r={}){var u;const a=ae(e),l=ae(n),d=Le(a),o=r.fromAddress||void 0,f=r.slippage!=null?r.slippage:1;let p=null;try{const h=`${se}/${i}/quote`,m=new URLSearchParams;m.set("fromTokenAddress",a),m.set("toTokenAddress",l),m.set("amount",String(s)),p=(await te.get(`${h}?${m.toString()}`)).data.toTokenAmount}catch{p=null}try{const h=`${se}/${i}/swap`,m=new URLSearchParams;m.set("fromTokenAddress",a),m.set("toTokenAddress",l),m.set("amount",String(s)),o&&m.set("fromAddress",o),m.set("slippage",String(f)),r.disableEstimate&&m.set("disableEstimate","true");const A={};r.apiKey&&(A.Authorization=`Bearer ${r.apiKey}`);const w=await te.get(`${h}?${m.toString()}`,{headers:A}),x=w.data.tx;let b=!1,C=null;if(!d&&o){const E=x.to,j=["function approve(address spender, uint256 amount) public returns (bool)"];C=new Y(j).encodeFunctionData("approve",[E,String(s)]),b=!0}return{to:x.to,data:x.data,value:x.value||"0",expectedAmountOut:p,estimatedGas:w.data.estimatedGas||null,approveNeeded:b,approveData:C,raw:w.data}}catch(h){const m=((u=h==null?void 0:h.response)==null?void 0:u.data)||h.message;throw new Error(`Aggregator swap build failed: ${typeof m=="object"?JSON.stringify(m):m}`)}}function Ue({open:e,onClose:n,swaps:s=[],onSubmit:i,swapping:r}){return e?t.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsxs("div",{style:{background:"white",padding:16,maxWidth:800,width:"90%",borderRadius:8},children:[t.jsx("h3",{children:"Confirm Sweep"}),t.jsx("div",{style:{maxHeight:300,overflow:"auto"},children:t.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{style:{textAlign:"left"},children:"Token"}),t.jsx("th",{children:"Expected Out"}),t.jsx("th",{children:"Gas"}),t.jsx("th",{children:"Info"})]})}),t.jsx("tbody",{children:s.map((a,l)=>{var d,o;return t.jsxs("tr",{style:{borderTop:"1px solid #eee"},children:[t.jsx("td",{children:a.token}),t.jsx("td",{children:((d=a.swap)==null?void 0:d.expectedAmountOut)??"-"}),t.jsx("td",{children:((o=a.swap)==null?void 0:o.estimatedGas)??"-"}),t.jsx("td",{style:{fontSize:12,color:"#666"},children:a.error?`Error: ${a.error}`:"OK"})]},l)})})]})}),t.jsxs("div",{style:{marginTop:12,display:"flex",gap:8,justifyContent:"flex-end"},children:[t.jsx("button",{onClick:n,disabled:r,children:"Cancel"}),t.jsx("button",{onClick:i,disabled:r,children:r?"Submitting...":"Submit sweep"})]})]})}):null}function $e(){const[e,n]=g.useState({}),[s,i]=g.useState(137),[r,a]=g.useState([]),[l,d]=g.useState(5),[o,f]=g.useState("USDC"),[p,u]=g.useState(new Set),[h,m]=g.useState(null),[A,w]=g.useState(null),[x,b]=g.useState([]),[C,E]=g.useState(!1),[j,P]=g.useState(""),[v,O]=g.useState(""),[N,T]=g.useState(!0),[W,Z]=g.useState(!1);g.useEffect(()=>{async function c(){try{const k=[{symbol:"USDC",address:s===1?"0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48":"0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174"},{symbol:"WETH",address:s===1?"0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2":void 0}].filter(Boolean);a(k)}catch{m("Failed to load token list")}}c()},[s]);async function J(){const c=[];for(const k of r)try{const y=await Ne(k.address,s,{provider:e.provider});c.push({...k,price:y.price,src:y.source})}catch{c.push({...k,price:null,src:"error"})}a(c)}g.useEffect(()=>{r.length&&J()},[e,s]);async function de(){m(null),w("building");try{const c=Array.from(p),k=await re(c),y=[];for(const D of c)try{const _=r.find(L=>{var U;return((U=L.address)==null?void 0:U.toLowerCase())===(D==null?void 0:D.toLowerCase())}),M=e&&e.provider&&e.address&&_?await(async()=>{try{return(await new B(_.address,["function balanceOf(address) view returns (uint256)"],e.provider).balanceOf(e.address)).toString()}catch{return q("1",18).toString()}})():q("1",18).toString(),G=await le(D,o==="USDC"?s===1?"0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48":"0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174":I,M,s,{fromAddress:e==null?void 0:e.address,slippage:1});y.push({token:D,swap:G,amount:M})}catch(_){y.push({token:D,error:String(_)})}w({state:"ready",swaps:y.length,details:y}),b(y),E(!0)}catch{m("Failed to build permit or swap calldata"),w(null)}}return t.jsxs("div",{children:[t.jsx(Ae,{onChange:n,onChainChange:i}),t.jsxs("div",{style:{marginTop:12},children:[t.jsxs("label",{children:["Max price ($): ",t.jsx("input",{type:"number",value:l,onChange:c=>d(c.target.value)})]}),t.jsxs("label",{style:{marginLeft:12},children:["Target token: ",t.jsxs("select",{value:o,onChange:c=>f(c.target.value),children:[t.jsx("option",{children:"USDC"}),t.jsx("option",{children:"ETH"})]})]})]}),t.jsxs("div",{style:{marginTop:12},children:[t.jsxs("label",{style:{marginRight:8},children:["Sweeper contract: ",t.jsx("input",{value:j,onChange:c=>P(c.target.value),placeholder:"0x..."})]}),t.jsxs("label",{style:{marginRight:8},children:["Permit2 contract: ",t.jsx("input",{value:v,onChange:c=>O(c.target.value),placeholder:"0x..."})]}),t.jsxs("label",{style:{marginRight:8},children:["Partial success: ",t.jsx("input",{type:"checkbox",checked:N,onChange:c=>T(c.target.checked)})]}),t.jsxs("div",{style:{marginTop:8},children:[t.jsx("button",{onClick:J,children:"Refresh prices"}),t.jsx("button",{style:{marginLeft:8},onClick:de,children:"Build Permit & Sweep"})]})]}),h&&t.jsx(je,{message:h}),t.jsxs("div",{style:{marginTop:20},children:[t.jsx("h3",{children:"Tokens"}),t.jsxs("table",{children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{}),t.jsx("th",{children:"Symbol"}),t.jsx("th",{children:"Price"}),t.jsx("th",{children:"Est out"}),t.jsx("th",{children:"Gas"})]})}),t.jsx("tbody",{children:r.map(c=>(c.price===null||c.price<=Number(l))&&t.jsx(qe,{token:c,chainId:s,targetToken:o,providerOpts:e,onSelect:k=>{const y=new Set(p);y.has(c.address)?y.delete(c.address):y.add(c.address),u(y)}},c.address))})]})]}),t.jsx(Ce,{status:A}),t.jsx(Ue,{open:C,swaps:x,onClose:()=>E(!1),onSubmit:async()=>{var c,k,y;if(!j){m("Specify Sweeper contract address");return}Z(!0);try{const D=e==null?void 0:e.signer;if(!D)throw new Error("Wallet not connected");const _=["function sweepAndSwap(address,bytes,address[],uint256[],uint256[],uint8,address,bytes[],bool) payable"],M=new B(j,_,D),F=x.map(S=>S.token),G=x.map(S=>S.amount?S.amount.toString():"0"),L=F.map(S=>0),U=F.map(S=>be),ue=8,me={1:"0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",137:"0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174"},K=r.find(S=>S.symbol===o),fe=(K==null?void 0:K.address)||(o==="USDC"?me[s]||I:I),pe=x.map(S=>{var R,Q,ee;return S.swap?((R=S.swap.swap)==null?void 0:R.data)||S.swap.data||((ee=(Q=S.swap.raw)==null?void 0:Q.tx)==null?void 0:ee.data):"0x"}),z=F;let $;z.length>1?$=await Fe(z,{signer:e==null?void 0:e.signer,permit2Address:v,spender:j,chainId:s,amounts:G}):$=await re(z,{signer:e==null?void 0:e.signer,permit2Address:v,spender:j,chainId:s,amount:G[0]});const he=($==null?void 0:$.permitCalldata)||"0x";let X=0n;for(const S of x){const R=((c=S.swap)==null?void 0:c.value)||((y=(k=S.swap)==null?void 0:k.swap)==null?void 0:y.value)||"0";R&&R!=="0"&&(X+=BigInt(R.toString()))}const ge=await M.sweepAndSwap(v||I,he,F,L,U,ue,fe,pe,N,{value:X});w("submitted"),await ge.wait(),w("confirmed")}catch(D){m(String(D)),w(null)}finally{Z(!1),E(!1)}},swapping:W})]})}function qe({token:e,onSelect:n,chainId:s,targetToken:i,providerOpts:r}){const[a,l]=g.useState(null);return g.useEffect(()=>{let d=!0;async function o(){if(e.address)try{const f=i==="USDC"?s===1?"0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48":"0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174":I,p=q("1",18).toString(),u=await le(e.address,f,p,s,{fromAddress:r==null?void 0:r.address,slippage:1});d&&l({amountOut:u.expectedAmountOut,gas:u.estimatedGas})}catch{d&&l(null)}}return o(),()=>{d=!1}},[e,s,i,r]),t.jsxs("tr",{children:[t.jsx("td",{children:t.jsx("input",{type:"checkbox",onChange:n})}),t.jsx("td",{children:e.symbol}),t.jsx("td",{children:e.price?`$${e.price.toFixed(4)}`:"n/a"}),t.jsx("td",{children:a?a.amountOut:"—"}),t.jsx("td",{children:a?a.gas:"—"})]})}function Oe(){return t.jsxs("div",{style:{padding:20},children:[t.jsx("h1",{children:"Sweeper Demo"}),t.jsx($e,{})]})}const Me=document.getElementById("root"),Ge=xe(Me);Ge.render(t.jsx(Oe,{}));
